<?php
/**
 * Implements hook_menu().
 */
function mp_liangyou_menu() {
  $items['get_upyun_token/%'] = array(
    'title' => '',
    'page callback' => 'get_upyun_token',
    'page arguments' => array(1,2),
    'access arguments' => array('access content'),
    'type' => MENU_SUGGESTED_ITEM,
   );
  $items['cc_liangyou'] = array(
    'page callback' => '_mp_liangyou_cc',
    'access arguments' => array('access content'),
    'type' => MENU_SUGGESTED_ITEM,
   );
  return $items;
}
function _mp_liangyou_cc(){
	cache_clear_all('mp_liangyou', 'cache', TRUE); //once a day!
	header('Content-type: application/json');
	print '[{"hi":"clean"}]';
}
function get_upyun_token($code,$offset=0){
	$cdnlink = 'http://lywxaudio.b0.upaiyun.com';
	require_once('liangyou_audio_list.php');
  $audios = liangyou_audio_list2();
  $lyaudio = $audios[$code];
	$title = $lyaudio['title'];
	// $offset=7;
	$date = date('ymd',time()-$offset*86400);
	$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
	$musicurl = $cdnlink.$path.upyun_get_token($path,86400);
	return $musicurl;
	// header('Content-type: application/json');
	// print drupal_json_encode($musicurl);
}
/**
 * hook_rescources_info
 */
function mp_liangyou_rescources_info(){
	$rescources[] = array(
    'name' => 'ly2',
    'desc' =>	'良友电台【600】',
  );
	$rescources[] = array(
    'name' => '365',
    'desc' =>	'恩典【365】【366】',
  );
	$rescources[] = array(
    'name' => '523',
    'desc' =>	'在天父怀中【523】',
  );
	$rescources[] = array(
    'name' => '400',
    'desc' =>	'圣经广播网【400】',
  );
	$rescources[] = array(
    'name' => '1225',
    'desc' =>	'耶稣全貌【1225】',
  );
	// $rescources[] = array(
 //    'name' => 'swty',
 //    'desc' =>	'世外桃源【ty】',
 //  );
  return $rescources;
}

/**
 * hook_wxrescources
 * TODO:	cache_clear_all('mp_liangyou', 'cache', TRUE); once a day!
 */
function mp_liangyou_wxresources($resources, $account, $keyword){
  $my_data = &drupal_static(__FUNCTION__);
  if (!isset($my_data)) {
    if ($cache = cache_get('mp_liangyou_wxresources_'.$account->uid.$keyword)) {
      $my_data = $cache->data;
    }else {
      $my_data = _mp_liangyou_wxresources($resources, $account, $keyword);
      //cache = 0;永久缓存 cache = 43200;缓存一天／2
      if(isset($my_data['key_'.$keyword]['cache'])){
        if($my_data['key_'.$keyword]['cache']==0){
          cache_set('mp_liangyou_wxresources_'.$account->uid.$keyword, $my_data, 'cache');
        }else{
          cache_set('mp_liangyou_wxresources_'.$account->uid.$keyword, $my_data, 'cache', time() + $my_data['key_'.$keyword]['cache']);
        }
      }
    }
  }
  return $my_data;
}

function _mp_liangyou_wxresources($resources, $account, $keyword){
	$enabled_resources = variable_get('wechat_resources_'.$account->uid, array());
  {
  	if($keyword == 'ly'||$keyword == '良友'){
  		$file_key = drupal_realpath('public://cron/txly2/'.date('Ymd').'.json');
  		$data = json_decode(file_get_contents($file_key),true);
  		$news = array();
      $str = '';
  		foreach ($data as $key => $radio) {
  			if($radio['index'] =='604') continue;
  			$str .= '【'.$radio['index'].'】'.$radio['title'].'=>'.$radio['desc']."\n";
  		}
  		$img = array(
            'Title'=> '【今日良友节目概览】',
            'Description'=> $str."\n永不止息，需要有你\n回复【】内编号即可收听[加油]！",
            'PicUrl'=> 'http://mmbiz.qpic.cn/mmbiz/0fV5QBhibUJjvmqqUbJaL3ZPqIBKxPKpkq4SvjmagLGia5X6SDhTDKLY49qhWqE7ibyb6N1QUelvHv0ZnL5V7HWicA/640?wx_fmt=jpeg&tp=webp&wxfrom=5.jpg',
            'Url'=> 'http://ly.yongbuzhixi.com',
          );
      $news[] = $img;
		 	$resources['key_'.$keyword]= array(
        'type'  =>  'news',
        'cache' =>  43200,
        'obj'   =>  $news,
        );
			return $resources;
  	}
  	if($keyword == 'zb'||$keyword == '直播'){
	   	$resources['key_'.$keyword]= array(
				'type'	=>	'music',
				'cache' =>  43200,
				'obj'		=> array(
				'title'	=> '【zb】良友直播',
				'desc'	=>	'点击►收听 耐心等待数秒钟 公众号:永不止息',
				'musicurl'	=> 'http://ly729.out.airtime.pro:8000/ly729_a?'.time().'061.mp3',
				'hgmusicurl'	=>	'http://ly729.out.airtime.pro:8000/ly729_a?'.time().'061.mp3',
				),
			);

  	}
		// 600-652 stream ly
		require_once('liangyou_audio_list.php');
		$cdnlink = 'http://lywxaudio.b0.upaiyun.com';
	  if(isset($enabled_resources['ly2']) && $enabled_resources['ly2']){
			if($keyword == 600){
			 	$resources['key_'.$keyword] = array(
					'type'	=>	'text',
					'cache' =>  0,
					'obj'		=> array(
						'text'	=> ly_stream_menu(),
					)
				);
				return $resources;
			}
			$orikeyword = $keyword;
		  $audios = liangyou_audio_list2();
		  $lyaudio = array();
		  $lyaudio_code = FALSE;
		  if($orikeyword=='bv') $keyword='mw';
		  foreach ($audios as $code => $audio) {
		  	//ee cc gv hg + 空中辅导 ＝》603  603=603
		  	if(strpos($keyword, $code) !==false || strpos($keyword, $audio['title']) !==false || $audio['index']==$keyword){
		  		$keyword = $audio['index'];//cc =>603
		  		$lyaudio = $audio;
		  		$lyaudio_code = $code;
		  		break;
		  	}
		  }
		  if(is_numeric($keyword) && ($keyword>600 && $keyword<=656) ) {
		  	if($keyword>=641 && $keyword<=645){
		    // if(0)
			    {
			    	require_once('liangyou.inc');
				    $file_path = DRUPAL_ROOT.'/sites/default/files/cron/lycloudjson/';
				    // if (!is_dir($file_path)) {
				    //   mkdir($file_path, 0777, true);
				    // }
				    // $file_key = dirname(__FILE__).'/'.date('Ymd').'.json';
				    $file_key = drupal_realpath('public://cron/lycloudjson/'.date('Ymd').'.json') ;
				    if(!file_exists($file_key))  {
							$radios = ly_stream_source();
							foreach ($radios as $key => $radio) {
							  // $url = $radio['url'];
							  // $title = $radio['title'];
							  $url = $radio;
							  $title = $key;

							  $html = file_get_html($url);
							  if(!$html) {
							  	watchdog('mp_liangyou', 'lost audio:'.$title, array(), WATCHDOG_NOTICE, 'error');
							  	continue;
							  }
							  $url = $html->find('#div_playlist li', 0);

							  $title_get = $html->find('#div_playlist li .mp3_title', 0)->plaintext;
							  $mp3_description = $html->find('#div_playlist li .mp3_description', 0)->plaintext;
							  $dates = explode('-', $title_get);
							  $data[] = array(
							    'title' => $title,
							    'date' => $dates[1],
							    'url'   =>  $url->attr['data-stream'],
							    'desc'  => $mp3_description,
							    );
							  // break;
							}
							// var_dump($data);
							$file = json_encode($data);
							if(!is_null($file)){
							  file_put_contents( $file_key , $file );
							  // $file_key = dirname(__FILE__).'/'.date('Ymd',time()-86400).'.json';
							  // if(file_exists($file_key))
							  // 	unlink($file_key);
							  watchdog('mp_liangyou', 'Success download ly audio list from stream', array(), WATCHDOG_NOTICE, 'link');
							}
						}

				    $file = file_get_contents($file_key);
				    $urls = json_decode($file,TRUE);
				    if($keyword == 600){
				     	$resources['key_'.$keyword] = array(
								'type'	=>	'text',
								'cache' =>  0,
								'obj'		=> array(
								'text'	=> ly_stream_menu(),
								)
							);
				    }else{
					    // $orikeyword = $keyword;
					    $keyword = $orikeyword - 601;
					    // watchdog('keyword '.$before_keyword , $keyword, array(), WATCHDOG_NOTICE, 'link');
					    $title = str_replace($keyword, '', $urls[$keyword]['title']);
					    $musicurl = $urls[$keyword]['url'].'?='.$urls[$keyword]['date'].'.mp3';
					    $desc =  substr($urls[$keyword]['date'], 4).' '.truncate_utf8($urls[$keyword]['desc'], 16, $wordsafe = FALSE, $add_ellipsis = TRUE, $min_wordsafe_length = 1);
					    $resources['key_'.$orikeyword]= array(
								'type'	=>	'music',
								'cache' =>  43200,
								'obj'		=> array(
								'title'	=> $title,
								'desc'	=>	$desc,
								'musicurl'	=>	$musicurl,
								'hgmusicurl'	=>	$musicurl,
								),
							);
							// watchdog('resources ', print_r($resources,TRUE), array(), WATCHDOG_NOTICE, 'link');
				    }
						return $resources;
					}
		  	}
				if(date('N')>5&&$keyword=='612') {//【612】书香园地＝》【614】今夜心未眠
					$keyword = '614';
				}
				if(date('N')>5&&$keyword=='604') {//【604】炼爱季节＝》【605】幸福满家园
					$keyword = '605';
				}
				if(date('N')>5&&$keyword=='606') {//【606】亲情不断电＝》【605】幸福满家园
					$keyword = '605';
				}
				if(date('N')>5&&$keyword=='609') {//【609】微播出炉=>【610】生活无国界
					$keyword = '610';
				}
				if(date('N')>5&&$keyword=='623') {//【623】齐来颂扬＝》【615】彩虹桥
					$keyword = '615';
				}
				if(date('N')>5&&$keyword=='608') {//【608】绝妙当家＝》【610】生活无国界
					$keyword = '610';
				}
				if(date('N')<=5&&$keyword=='605') {//【605】幸福满家园=>【606】亲情不断电
					$keyword = '606';
				}

				if($keyword=='603'){
					$title = $lyaudio['title'];
					$code = $lyaudio_code;
					$offset=7;
					$date = date('ymd',time()-$offset*86400);
					$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
					$musicurl = $cdnlink.$path;//.upyun_get_token($path);
					// $temp = @get_headers($musicurl);
					// if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
					// $title = $title;
						$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' 每日更新';
						$resources['key_'.$orikeyword]= array(
							'type'	=>	'music',
							'gakey'		=>	$keyword,
							'path'	=>	$path,
							'cache' =>  43203,
							'obj'		=> array(
								'title'	=>  '【'.$keyword.'】'.$title.'♪',
								'desc'	=> $desc,
								'musicurl'	=>	$musicurl,
								'hgmusicurl'	=>	$musicurl,
							),
						);
						return $resources;
					// }
				}
				//USE UPYUN
				{
					if($lyaudio_code){
						$title = $lyaudio['title'];
						$code = $lyaudio_code;
						$offset=0;
						while ($offset <= 7) {
							$date = date('ymd',time()-$offset*86400);
							$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
							$musicurl = $cdnlink.$path;
							$upyunurl = $cdnlink.$path.upyun_get_token($path);
							$temp = @get_headers($upyunurl);
							if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
								$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").($offset?$date:' 每日更新');
								$resources['key_'.$orikeyword]= array(
									'type'	=>	'music',
									'gakey'		=>	$keyword,
									'path'	=> $path,
									'cache'	=> 43201,
									'obj'		=> array(
										'title'	=>  '【'.$keyword.'】'.$title.'♪',
										'desc'	=> $desc,
										'musicurl'	=>	$musicurl,
										'hgmusicurl'	=>	$musicurl,
									),
								);
								return $resources;
							}
							$offset++;
						}
					}
				}
		    //UPYUN END
		  }
	  }
	  //523
	  if(isset($enabled_resources['523']) && $enabled_resources['523'])
	 	if($keyword == '523'){
      $title = '在天父怀中';
      $str = date('md');
      //http://audio1.liangyou.net/files/media/ly_daily/2013Daily_130114.mp3
      $musicurl = 'http://inhim.qiniudn.com/2013Daily_13'.$str.'.mp3';
      $desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息")." 每日更新 ".date('md');
      $url = $musicurl;
      $resources['key_'.$keyword]= array(
				'type'	=>	'music',
				'cache'	=> 43200,
				'obj'		=> array(
					'title'	=> $title.'♫',
					'desc'	=>	$desc,
					'musicurl'	=>	$url,
					'hgmusicurl'	=>	$url,
				),
			);
			return $resources;
	 	}

	  //365||366
	  $check_word = substr($keyword, 0,3);
	  if(isset($enabled_resources['365']) && $enabled_resources['365'])
	  if($check_word == '365' || $check_word == '366' ) {
	    $str = date('md');
	    if (strlen($keyword) ==7) {
	      $str = substr($keyword, 3,5);//0430
	      $month = (int) substr($str, 0,2);
	    }
	    $title = "恩典365";// '【'.$check_word.'】'.
	    $year = ($check_word=='365')?'2013':'2014';
	    $url = 'http://grace365.qiniudn.com/'.$year.'/'.$str.'.mp3';
	    $desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息")." 每日更新";
	    $resources['key_'.$keyword]= array(
				'type'	=>	'music',
				'cache'	=> 43200,
				'obj'		=> array(
					'title'	=> $title.'♫',
					'desc'	=>	$desc,
					'musicurl'	=>	$url,
					'hgmusicurl'	=>	$url,
				),
			);
			return $resources;
	  }

    //圣经广播网 400-435
    if(isset($enabled_resources['400']) && $enabled_resources['400'])
    if(is_numeric($keyword) && ($keyword>=400 && $keyword<=435) ) {
    	$resources = mp_bbn_response($keyword,$account);
    }

 		if(isset($enabled_resources['1225']) && $enabled_resources['1225']){
	    //122501 http://www.ysqm.org/stream/ch-
	    if(substr($keyword, 0,4) == '1225' && strlen($keyword) ==6 ) {
	      require_once('ysqm.inc');
	      $str = substr($keyword, 4,6);
	      $str = str_pad($str%22,2,"0",STR_PAD_LEFT);
	      $ysqm = get_ysqm();
	      $musicurl = 'http://bibles.qiniudn.com/ysqm/ch-'.$str.'.mp3';
	      $title = $ysqm[(int)$str];
	      $desc = '公众号:'.variable_get('mp_config_appname_'.$account->uid, "永不止息").' 圣诞特辑《耶稣全貌》';
	      $resources['key_'.$keyword]= array(
					'type'	=>	'music',
					'cache'	=> 43200,
					'obj'		=> array(
						'title'	=> $title,
						'desc'	=>	$desc,
						'musicurl'	=>	$musicurl,
						'hgmusicurl'	=>	$musicurl,
					),
				);
				return $resources;
	    }
	    //122501 http://www.ysqm.org/stream/ch-
	    if($keyword == '1225') {
	      $str = str_pad(date('d')%22,2,"0",STR_PAD_LEFT);
	      require_once('ysqm.inc');
	      $ysqm = get_ysqm();
	      $title = $ysqm[(int)$str];
	      $musicurl = 'http://bibles.qiniudn.com/ysqm/ch-'.$str.'.mp3';
	      $desc = '公众号:'.variable_get('mp_config_appname_'.$account->uid, "永不止息").' 《耶稣全貌》';
	      $hgmusicurl = $musicurl;
	      $resources['key_'.$keyword]= array(
					'type'	=>	'music',
					'cache'	=> 43200,
					'obj'		=> array(
						'title'	=> $title,
						'desc'	=>	$desc,
						'musicurl'	=>	$musicurl,
						'hgmusicurl'	=>	$musicurl,
					),
				);
				return $resources;
	    }
 		}

 		// if(isset($enabled_resources['swty']) && $enabled_resources['swty']){
 		// 	if(substr($keyword, 0,2) == 'ty' || substr($keyword, 0,4) == 'swty' || $keyword == '世外桃源') {
	 	// 		require_once('swty.inc');
	 	// 		$resources['key_'.$keyword] = wx_swty_resource_response($keyword);
	 	// 	}
 		// }
 		// TO DO: DELETE!
 		require_once('liangyou.inc');
		//a1 b1 c1 d1 e1 f1-f9
		if(isset($enabled_resources['mav']) && $enabled_resources['mav']){
			// $keyword = 'd11';
			$first = substr($keyword, 0,1);
			$second = substr($keyword, 1,1);
			$temp = array('a','b','c','d','e','f','g');
			if(in_array($first, $temp) && $second>0 && $second<10 ){
				$third = substr($keyword, 2,2);
				$mav = get_ly_mav();
				if(isset($mav[$first.$second])){
					$mav = $mav[$first.$second];
				}else{
					return $resources['key_'.$keyword]= array(
							'type'	=>	'text',
							'obj'		=> array(
								'text'	=> "[大哭]编码有误，请回复a0、b0、c0...f0查看目录哦！",
							)
						);
				}
				$level = (($mav['level'] == 1)?'本科课程':'进深课程');
				if($third>0&&$third<=$mav['count']){
					//24 => 001
					$count = $mav['count'];
					if($count<9)
						$count = '0'.$count;
					$rep = str_pad($third, 2,'0',STR_PAD_LEFT);
					$link = 'new/'.$level.'/'.$mav['title'].'/'.$mav['prefex'].$rep.'.mp3';

					$etime = time()+3600; // 授权十分钟后过期
					$key = 'ly729';   // token 防盗链密钥
					$path = '/'.$link; // 图片相对路径
					$sign = substr(md5($key.'&'.$etime.'&'.$path), 12,8).$etime;

					$cdn = 'http://lts33.b0.upaiyun.com/';
					$link = $cdn . urlencode($link).'?_upt='.$sign;
					$resources['key_'.$keyword]= array(
						'type'	=>	'music',
						'obj'		=> array(
							'title'	=> $mav['title'].'-'.$rep,
							'desc'	=>	"良友圣经学院 ".$level." 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息")." 点击►收听",
							'musicurl'	=>	$link,
							'hgmusicurl'	=>	$link,
						),
					);
				}else{
					//编码对，编号不对！
					$path = 'new/'.$level.'/'.$mav['title'].'/'.$mav['title'].'.pdf';
					$cdn = 'http://lts33.b0.upaiyun.com/';


					$etime = time()+864000; // 授权十天后过期
					$key = 'ly729';   // token 防盗链密钥
					$path = '/'.$path; // 图片相对路径
					$sign = substr(md5($key.'&'.$etime.'&'.$path), 12,8).$etime;

					$link = $cdn . urlencode($path).'?_upt='.$sign;

					if($mav['pdf']>0){
						$resources['key_'.$keyword]= array(
							'type'	=>	'text',
							'obj'		=> array(
								'text'	=> "恭喜您，良院 $level 《".$mav['title']."》已结束！\n回复".$first.($second+1)."1学习下一门课程[强]\n".'<a href="http://ly.yongbuzhixi.com/pdfviewer/web/?pdf='.$link.'&q='.time().'">查看'.$mav['title'].'讲义</a>',
							)
						);
					}else{
						$resources['key_'.$keyword]= array(
							'type'	=>	'text',
							'obj'		=> array(
								'text'	=> "[大哭]本科没有讲义哦！",
							)
						);
					}
				}
			}else{
				$menu = array('a0','b0','c0','d0','e0','f0','g0');
				$temp_keyword = substr($keyword, 0,2);
				$first = substr($keyword, 0,1);
				if(in_array($temp_keyword, $menu)){
					$mav = get_ly_mav();
					if(in_array($temp_keyword, array('e0','f0','g0'))){
						$level = '进深';
					}else{
						$level = '本科';
					}
					$mavmenu = '良院'.$level.'文凭课程目录'.$first."\n";
					foreach ($mav as $key => $value) {
						if(strpos($key,$first) !== false){
							$mavmenu .= "【".$key."】".$value['title']."\n";
						}
					}
					$mavmenu .="回复【".$first."11】，即可获得第一课[强]";
					$resources['key_'.$keyword]= array(
						'type'	=>	'text',
						'obj'		=> array(
						'text'	=> $mavmenu,
						)
					);
				}
			}
		}//end of 良友圣经学院
		//x0 y0 z0
		// 		阮老师，我在设计新的良院编码，这样可以吗？：
		// 用户回复【基础课程】或【jckc】可得到基础课程8科按顺序排列的节目，8*24+1(pdf)=200天循环一次。
		// 每个科目，比如事奉装备，用户回复【事奉装备】或【sfzb】获得当天节目，25天一循环，收听14课可以回复【sfzb14】
		//begin new 良友圣经学院
		if(isset($enabled_resources['jckc']) && $enabled_resources['jckc']){
			if($keyword == '基础' || $keyword == 'jc'){
				$mav = get_ly_jckc();
				$mavmenu = "良院基础课程目录\n";
				foreach ($mav as $key => $value) {
					$mavmenu .= "【J".$value['order']."】".$value['title']."\n";//"【".strtoupper($key)."】".
				}
				$mavmenu .="回复【J11】，即可获得第一课[强]";
				$resources['key_'.$keyword]= array(
					'type'	=>	'text',
					'obj'		=> array(
					'text'	=> $mavmenu,
					)
				);
				return $resources;
			}

			$temp_keyword = $keyword;
			if($keyword == '基础课程' || $keyword == 'jckc'){
				$index_day = date('z');
				$total = 25;
				$index1 = $index_day%200;//200天一循环！
				// dvm($index1);
				// dvm($index1%25,'课');
				// dvm(ceil($index1/25),'单元');
				$course_id = $index1%$total;//课
				$course_index = ceil($index1/$total);//单元
				$temp_keyword = 'j'.$course_index.$course_id;//326 j1514
				// watchdog('course_id', $course_id, array(), WATCHDOG_NOTICE, 'link');
				// watchdog('course_index', $course_index, array(), WATCHDOG_NOTICE, 'link');
				// watchdog('keyword', $keyword, array(), WATCHDOG_NOTICE, 'link');
			}

			//J11 J124 J21 J224...
			$first = substr($temp_keyword, 0,1);//J
			$second = substr($temp_keyword, 1,1);//1-8
			$temp = array('j');
			$level = '基础课程';

			if(in_array($first, $temp) && $second>0 && $second<10 ){
				$third = substr($temp_keyword, 2,2);
				$mav = get_ly_jckc();
				if(!isset($mav[$second])){
					$resources['key_'.$keyword]= array(
						'type'	=>	'text',
						'obj'		=> array(
							'text'	=> "啊呜，指令不对，出错啦！请回复【jc】或【基础】查看指令！",
						)
					);return $resources;
				}
				$mav = $mav[$second];
				if($third>0&&$third<=$mav['max']){
					//24 => 001
					$count = $mav['max'];
					$index = str_pad($third, 2,'0',STR_PAD_LEFT);


					$link = 'new/'.$level.'/'.$mav['title'].'/'.$mav['prefex'].$index.'.mp3';

					$etime = time()+3600; // 授权十分钟后过期
					$key = 'ly729';   // token 防盗链密钥
					$path = '/'.$link; // 图片相对路径
					$sign = substr(md5($key.'&'.$etime.'&'.$path), 12,8).$etime;

					$cdn = 'http://lts33.b0.upaiyun.com/';
					$link = $cdn . urlencode($link).'?_upt='.$sign;
					$resources['key_'.$keyword]= array(
						'type'	=>	'music',
						'obj'		=> array(
							'title'	=> $mav['title'].'-'.$index,
							'desc'	=>	"良友圣经学院 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息")." 点击►收听",
							'musicurl'	=>	$link,
							'hgmusicurl'	=>	$link,
						),
					);return $resources;
				}else{
					//编码对，编号不对！
					$link = 'new/'.$level.'/'.$mav['title'].'/'.$mav['title'].'.pdf';
					$cdn = 'http://lts33.b0.upaiyun.com/';


					$etime = time()+864000; // 授权十天后过期
					$key = 'ly729';   // token 防盗链密钥
					$path = '/'.$link; // 图片相对路径
					$sign = substr(md5($key.'&'.$etime.'&'.$path), 12,8).$etime;

					$link = $cdn . urlencode($path).'?_upt='.$sign;
					$resources['key_'.$keyword]= array(
						'type'	=>	'text',
						'obj'		=> array(
							'text'	=> "恭喜您，良友圣经学院 $level 《".$mav['title']."》已结束！\n回复J".($second+1)."1学习下一门课程[强]\n".'<a href="http://ly.yongbuzhixi.com/pdfviewer/web/?pdf='.$link.'">查看'.$mav['title'].'讲义</a>',
						)
					);return $resources;
				}
			}
			//
			//end of new 良友圣经学院
		}
		//begin lysd sd1-sd999
		$orikeyword = $keyword;
		$check_keyword = substr($keyword, 0,2);
		$index = substr($keyword, 2,3);
		if($check_keyword == 'sd'){
			$lysd = get_lysd();
			if($keyword == 'sd'){
				$mavmenu = "----良友礼品卡----\n";
				foreach ($lysd as $key => $value) {
					$mavmenu .= $key.' sd'.$value['begin'].'-sd'.$value['end']."\n";
				}
				$resources['key_'.$keyword]= array(
					'type'	=>	'text',
					'cache'	=> 0,
					'obj'		=> array(
					'text'	=> $mavmenu,
					)
				);
				return $resources;
			}
			if(is_numeric($index)){
				foreach ($lysd as $key => $value) {
					if($index>=$value['begin'] && $index<=$value['end']){
						$link = $value['title'].'/'.str_pad($index, 3,'0',STR_PAD_LEFT).'.mp3';

						// $etime = time()+3600; // 授权十分钟后过期
						// $key = 'ly729';   // token 防盗链密钥
						$path = '/lysd/'.$link; // 图片相对路径
						// $sign = substr(md5($key.'&'.$etime.'&'.$path), 12,8).$etime;
						//http://lyweixintest.b0.upaiyun.com/lysd/001.mp3
						$link = 'http://lyweixintest.b0.upaiyun.com/lysd/'.urlencode($link);//.'?_upt='.$sign;

						$resources['key_'.$orikeyword]= array(
							'type'	=>	'music',
							'cache'	=> 0,
							'path'	=> $path,
							'obj'		=> array(
								'title'	=> $value['title'],
								'desc'	=>	"良友礼品卡 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息")." 点击►收听",
								'musicurl'	=>	$link,
								'hgmusicurl'	=>	$link,
							),
						);
						return $resources;break;
					}
				}
			}
		}

	}
	return $resources;
}

/**
 * $change_keyword = return key!
 */
function mp_bbn_response($keyword,$account,$change_keyword=NULL){
	$resources = array();
	if (!$change_keyword) {
		$change_keyword = $keyword;
	}
	require_once('bbn.inc');
 	if($keyword == '400'){
		$resources['key_'.$change_keyword]= array(
			'type'	=>	'text',
			'cache' =>  0,
			'obj'		=> array(
			'text'	=> bbn_audio_menu(),
			)
		);
 	}else{
		$bbn = mp_get_bbn($keyword);
		$musicurl = $bbn[$keyword]['musicurl'];
		$title = $bbn[$keyword]['title'];
		$desc = '点击►收听 公众号:'.variable_get('mp_config_appname_'.$account->uid, "永不止息").' 每日更新';
		$resources['key_'.$change_keyword]= array(
			'type'	=>	'music',
			'cache' =>  43200,
			'obj'		=> array(
				'title'	=> $title,
				'desc'	=>	$desc,
				'musicurl'	=>	$musicurl,
				'hgmusicurl'	=>	$musicurl,
			),
		);
	}
	return $resources;
}

// 图片相对路径
// token 防盗链密钥
// 授权1分钟后过期
// 图片相对路径
// token 防盗链密钥
// 授权1分钟后过期
function upyun_get_token($path, $etime = 86400, $key = 'ly729'){
	$etime = time()+$etime; // 授权1分钟后过期
	return '?_upt='. substr(md5($key.'&'.$etime.'&'.$path), 12,8).$etime;
}
