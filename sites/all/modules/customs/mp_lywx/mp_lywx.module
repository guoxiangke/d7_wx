<?php
function lywx_menu(){
return
'输入以下数字代号，可以收听良友电台相关的节目：

生活智慧
101：微播出炉
102：书香园地
103：今夜心未眠
104：绝妙当家
105：生活无国界
106：零点零距离
107：iradio爱广播

关怀辅导
201：空中辅导
202：无限飞行号
203：i关怀心磁场

婚恋家庭
301：恋爱季节
302：幸福满家园
303：亲情不断电
304：欢乐卡恰碰

诗歌音乐
401：齐来颂扬
402：彩虹桥
403：长夜的牵引

慕道探索
501：生命的福音
502：现代人的希望
503：津津乐道

生命成长
601：旷野吗哪
602：生命的四季
603：拥抱每一天
604：施恩座前
605：这一刻清心
606：空中崇拜
607：燃亮的一生
608：佳美脚踪
609：真理之光
610：生根建造
611：给力人生
612：信仰百宝箱
613：空中门训

学习真道
701：真道分解
702：圣言盛宴
703：聆听主道
704：经动人心
705：好牧人
706：善牧良言
707：真理与柱石
708：生活之光

中英双语
801：蓝天绿洲
802：天路导向
803：天路导向粤

少数民族
901：恩典与真理
902：爱在人间

栽培训练
1001：接棒人
1002：晨曦讲座
1003：良院精选';
}
/**
 * hook_rescources_info
 */
function mp_lywx_rescources_info(){
  $rescources[] = array(
    'name' => 'ly',
    'desc' => '良友【100】',
  );
  return $rescources;
}
/**
 * HOOK_wxresources
 * @param  [type] $resources [description]
 * @param  [type] $account   [description]
 * @param  [type] $keyword   [description]
 * @return [type]            [description]
 */
function  mp_lywx_wxresources($resources, $account, $keyword){
  $enabled_resources = variable_get('wechat_resources_'.$account->uid, array());
  if(!(isset($enabled_resources['ly']) && $enabled_resources['ly'])){
    return;
  }
  $my_data = _mp_lywx_wxresources($resources, $account, $keyword);
  // return $my_data;
  $my_data = &drupal_static(__FUNCTION__);
  if (!isset($my_data)) {
    if ($cache = cache_get('mp_lywx_wxresources_'.$account->uid.$keyword)) {
      $my_data = $cache->data;
    }else {
      $my_data = _mp_lywx_wxresources($resources, $account, $keyword);
      //cache = 0;永久缓存 cache = 43200;缓存一天／2
      if(isset($my_data['key_'.$keyword]['cache'])){
        if($my_data['key_'.$keyword]['cache']==0){
          cache_set('mp_lywx_wxresources_'.$account->uid.$keyword, $my_data, 'cache');
        }else{
          cache_set('mp_lywx_wxresources_'.$account->uid.$keyword, $my_data, 'cache', time() + $my_data['key_'.$keyword]['cache']);
        }
      }
    }
  }
  return $my_data;
}

function _mp_lywx_wxresources($resources, $account, $keyword){
	module_load_include('php', 'mp_liangyou', 'liangyou_audio_list');
	$liangyou_audio_list = liangyou_audio_list_bylywxindex();
  $orikeyword = $keyword;
  // 101-901
	if(in_array($keyword, array_keys($liangyou_audio_list))){
    $lywx = (int)$keyword;
    if($lywx!=$keyword) {//TODO: 101,102,103!
      $text = '亲爱的知音人，请一次只发一个节目代码，谢谢!';
      $resources['key_'.$keyword] = array(
        'type'  =>  'text',
        'gadata'   =>  array(
           'category'        => 'lywxother',
           'action'          => $keyword,
           'label'           => '一次一个',
        ),
        'cache' =>  0,
        'obj'   => array(
          'text'  => $text,
        )
      );
      return $resources;
    }
		$liangyou_audio_list_info = $liangyou_audio_list[$keyword];
		$ori_title = $liangyou_audio_list_info['title'];
		$code = $liangyou_audio_list_info['code'];
		$lywx = $liangyou_audio_list_info['lywx'];
		// http://lywxaudio.b0.upaiyun.com/2016/zz/zz160205.mp3
		// $dir_stru = 'liangyou/nissigz/'.$title.'/'.date('Ym');

		$upyun_bucket_name = 'lywxaudio';
		$cdnlink = $upyun_bucket_name.'.b0.upaiyun.com';
		$offset=0;
		while ($offset <= 7) {
			$date = date('ymd',time()-$offset*86400);
			$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
			$musicurl = 'http://'.$cdnlink.$path;
      $upyunurl = $musicurl.upyun_get_token($path);
			$temp = @get_headers($upyunurl);
			if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
				$title = '【'.$lywx.'】'.$ori_title;
				$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' '.$date;
		    // $weObj->music($title , $desc, $musicurl, $musicurl)->reply();
        $resources['key_'.$orikeyword]= array(
          'type'  =>  'music',
          'gadata'   =>  array(
             'category'        => 'lywxaudio',
             'action'          => $ori_title,
             'label'           => '一次一个',
          ),
          'path'  => $path,
          'cache' => 43201,
          'obj'   => array(
            'title' => $title,
            'desc'  => $desc,
            'musicurl'  =>  $musicurl,
            'hgmusicurl'  =>  $musicurl,
          ),
        );
        return $resources;
			}
			$offset++;
		}
	}
  //get audio by title
	$liangyou_audio_list = liangyou_audio_list_bytitle();
	if(in_array($keyword, array_keys($liangyou_audio_list))){
		$liangyou_audio_list_info = $liangyou_audio_list[$keyword];
		$ori_title = $keyword;//$liangyou_audio_list_info['title'];
		$code = $liangyou_audio_list_info['code'];
		$lywx = $liangyou_audio_list_info['lywx'];
		// http://lywxaudio.b0.upaiyun.com/2016/zz/zz160205.mp3
		// $dir_stru = 'liangyou/nissigz/'.$title.'/'.date('Ym');

		$upyun_bucket_name = 'lywxaudio';
		$cdnlink = $upyun_bucket_name.'.b0.upaiyun.com';
		$offset=0;
		while ($offset <= 7) {
			$date = date('ymd',time()-$offset*86400);
			$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
			$musicurl = 'http://'.$cdnlink.$path;
      $upyunurl = $musicurl.upyun_get_token($path);
      $temp = @get_headers($upyunurl);
			if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
				$title = '【'.$lywx.'】'.$ori_title;
				$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' '.$date;
		    // $weObj->music($title , $desc, $musicurl, $musicurl)->reply();
        $resources['key_'.$orikeyword]= array(
          'type'  =>  'music',
          'gakey'   =>  $ori_title,
          'path'  => $path,
          'cache' => 43201,
          'obj'   => array(
            'title' =>  $title,
            'desc'  => $desc,
            'musicurl'  =>  $musicurl,
            'hgmusicurl'  =>  $musicurl,
          ),
        );
        return $resources;
			}
			$offset++;
		}
	}
	// $allowkeywords = array('节目','听节目','?');
	// if(in_array($keyword, $allowkeywords)){
	// 	$weObj->text(lywx_menu())->reply();
	// 	gapushagent('event',array(
	//    'category'        => 'lywxother',
	//    'action'          => $keyword,
	//    'label'           => 'menu get',
	//   ));
	// }

	$allowkeywords = array('消息','?');
	if(preg_match('/^([a-zA-Z])+/', $keyword)||in_array($keyword, $allowkeywords)){
    $img = array(
      'Title'=>"收听节目代号",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrYWM3MRmbJhVNEeuao0rG8Iyp2so7XhcKwLGqaKKZeIGD9LiclOZbGwbpYP2tGyex188qaKU1t8BWg/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401924143&idx=1&sn=9e7a4f6f8390b6a807060b99e9975c4a#rd',
    );
    $news[] = $img;
    $img = array(
      'Title'=>"良友电台网站链接",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrYWM3MRmbJhVNEeuao0rG8ICvBficvriakUDNGCBIzwQIOCvEQ8SXkvCPpBfkfLMPdNc3XQ3UkyRibDA/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401923760&idx=1&sn=768de843daf54c7fa4e66903e516db86#rd',
    );
    $news[] = $img;
    $img = array(
      'Title'=>"联络良友电台",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrYWM3MRmbJhVNEeuao0rG8IknoqbEyOqd7vYuUXF2nqUJEPqRZibo10tru4GASTbXM1q5ia2d5u7hicA/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401923513&idx=1&sn=7834a54dbe4463796daf2773743fcead#rd',
    );
    $news[] = $img;
    $resources['key_'.$keyword]= array(
      'type'  =>  'news',
      'gadata' => array(
       'category'        => 'lywxother',
       'action'          => 'news get',
       'label'           => $keyword,
       ),
      'cache' =>  43200,
      'obj'   =>  $news,
      );
    return $resources;
    // $weObj->news($news)->reply();
	}else{
    $resources['key_'.$keyword] = array(
      'type'  =>  'text',
      'gadata' => array(
       'category'        => 'lywxother',
       'action'          => 'menu get',
       'label'           => $keyword,
       ),
      'cache' =>  0,
      'obj'   => array(
        'text'  => lywx_menu(),
      )
    );
    return $resources;
		// $weObj->text(lywx_menu())->reply();
	}
}


/**
 * Hook_wxservice_event_alter
 */
function mp_lywx_wxservice_event_alter($weObj,$event,$account){
  $enabled_resources = variable_get('wechat_resources_'.$account->uid, array());
  if(!(isset($enabled_resources['ly']) && $enabled_resources['ly'])){
    return;
  }
  if(isset($event['key'])){
    mp_service_keyword_response($weObj,$event['key'],$account);
  }
  watchdog('event', '<pre>'.print_r($event, 1), array(), WATCHDOG_NOTICE, 'link');
  switch ($event['event']) {
    case 'subscribe':
      $weObj->text("亲爱的朋友，你好！感谢你关注良友电台官方订阅号“良友知音”！\n".lywx_menu());
      gapushagent('event',array(
       'category'        => 'lywxother',
       'action'          => 'subscribe',
       'label'           => $account->uid,
      ));
      break;
    case 'unsubscribe':
      gapushagent('event',array(
       'category'        => 'lywxother',
       'action'          => 'unsubscribe',
       'label'           => $account->uid,
      ));
      break;
    case 'VIEW'://MP menu!
      gapushagent('event',array(
       'category'        => 'lywxother',
       'action'          => '菜单浏览',
       'label'           => $account->uid,
      ));
      break;
    case 'MASSSENDJOBFINISH'://图文发送成功
      gapushagent('event',array(
       'category'        => 'lywxother',
       'action'          => '图文发送成功',
       'label'           => $account->uid,
      ));
      break;
    default:
      watchdog('mp_lywx', '<pre>'.print_r($event['event'], 1), array(), WATCHDOG_NOTICE, 'link');
      break;
  }
}
