<?php
function lywx_menu(){
return
'输入以下数字代号，可以收听良友电台相关的节目：

生活智慧
101：微播出炉
102：书香园地
103：今夜心未眠
104：绝妙当家
105：生活无国界
106：零点零距离
107：iradio爱广播

关怀辅导
201：空中辅导
202：无限飞行号
203：i关怀心磁场

婚恋家庭
301：恋爱季节
302：幸福满家园
303：亲情不断电
304：欢乐卡恰碰

诗歌音乐
401：齐来颂扬
402：彩虹桥
403：长夜的牵引

慕道探索
501：生命的福音
502：现代人的希望
503：津津乐道

生命成长
601：旷野吗哪
602：生命的四季
603：拥抱每一天
604：施恩座前
605：这一刻清心
606：空中崇拜
607：燃亮的一生
608：佳美脚踪
609：真理之光
610：生根建造
611：给力人生
612：信仰百宝箱
613：空中门训

学习真道
701：真道分解
702：圣言盛宴
703：聆听主道
704：经动人心
705：好牧人
706：善牧良言
707：真理与柱石
708：生活之光

中英双语
801：蓝天绿洲
802：天路导向
803：天路导向粤

少数民族
901：恩典与真理
902：爱在人间

栽培训练
1001：接棒人
1002：晨曦讲座
1003：良院精选';
}

function mp_lywx_keyword_response(&$weObj,$keyword,$account) {
	module_load_include('php', 'mp_liangyou', 'liangyou_audio_list');
	$liangyou_audio_list = liangyou_audio_list_bylywxindex();
	if(in_array($keyword, array_keys($liangyou_audio_list))){
		$liangyou_audio_list_info = $liangyou_audio_list[$keyword];
		$ori_title = $liangyou_audio_list_info['title'];
		$code = $liangyou_audio_list_info['code'];
		$lywx = $liangyou_audio_list_info['lywx'];
		// http://lywxaudio.b0.upaiyun.com/2016/zz/zz160205.mp3
		// $dir_stru = 'liangyou/nissigz/'.$title.'/'.date('Ym');

		$upyun_bucket_name = 'lywxaudio';
		$cdnlink = $upyun_bucket_name.'.b0.upaiyun.com';
		$offset=0;
		while ($offset <= 7) {
			$date = date('ymd',time()-$offset*86400);
			$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
			$musicurl = 'http://'.$cdnlink.$path.upyun_get_token($path);
			$temp = @get_headers($musicurl);
			if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
				$title = '【'.$lywx.'】'.$ori_title;
				$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' '.$date;
		    $weObj->music($title , $desc, $musicurl, $musicurl)->reply();

				gapushagent('event',array(
			   'category'        => 'lywxaudio',
			   'action'          => $ori_title,
			   'label'           => 'offset_'.$offset,
			  ));
	    	return;
			}
			$offset++;
		}
		{
			$weObj->text('亲爱的知音人，请一次只发一个节目代码，谢谢!')->reply();
			gapushagent('event',array(
		   'category'        => 'lywxother',
		   'action'          => $keyword,
		   'label'           => 'menu get',
		  ));
		}
	}

	$liangyou_audio_list = liangyou_audio_list_bytitle();
	if(in_array($keyword, array_keys($liangyou_audio_list))){
		$liangyou_audio_list_info = $liangyou_audio_list[$keyword];
		$ori_title = $keyword;//$liangyou_audio_list_info['title'];
		$code = $liangyou_audio_list_info['code'];
		$lywx = $liangyou_audio_list_info['lywx'];
		// http://lywxaudio.b0.upaiyun.com/2016/zz/zz160205.mp3
		// $dir_stru = 'liangyou/nissigz/'.$title.'/'.date('Ym');

		$upyun_bucket_name = 'lywxaudio';
		$cdnlink = $upyun_bucket_name.'.b0.upaiyun.com';
		$offset=0;
		while ($offset <= 7) {
			$date = date('ymd',time()-$offset*86400);
			$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
			$musicurl = 'http://'.$cdnlink.$path.upyun_get_token($path);
			$temp = @get_headers($musicurl);
			if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
				$title = '【'.$lywx.'】'.$ori_title;
				$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' '.$date;
		    $weObj->music($title , $desc, $musicurl, $musicurl)->reply();

				gapushagent('event',array(
			   'category'        => 'lywxaudio',
			   'action'          => $ori_title,
			   'label'           => 'offset_'.$offset,
			  ));
	    	return;
			}
			$offset++;
		}
	}
	// $allowkeywords = array('节目','听节目','?');
	// if(in_array($keyword, $allowkeywords)){
	// 	$weObj->text(lywx_menu())->reply();
	// 	gapushagent('event',array(
	//    'category'        => 'lywxother',
	//    'action'          => $keyword,
	//    'label'           => 'menu get',
	//   ));
	// }

	$allowkeywords = array('消息','?');
	if(preg_match('/^([a-zA-Z])+/', $keyword)||in_array($keyword, $allowkeywords)){
    $img = array(
      'Title'=>"收听节目代号",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrYWM3MRmbJhVNEeuao0rG8Iyp2so7XhcKwLGqaKKZeIGD9LiclOZbGwbpYP2tGyex188qaKU1t8BWg/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401924143&idx=1&sn=9e7a4f6f8390b6a807060b99e9975c4a#rd',
    );
    $news[] = $img;
    $img = array(
      'Title'=>"良友电台网站链接",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrYWM3MRmbJhVNEeuao0rG8ICvBficvriakUDNGCBIzwQIOCvEQ8SXkvCPpBfkfLMPdNc3XQ3UkyRibDA/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401923760&idx=1&sn=768de843daf54c7fa4e66903e516db86#rd',
    );
    $news[] = $img;
    $img = array(
      'Title'=>"联络良友电台",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrYWM3MRmbJhVNEeuao0rG8IknoqbEyOqd7vYuUXF2nqUJEPqRZibo10tru4GASTbXM1q5ia2d5u7hicA/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401923513&idx=1&sn=7834a54dbe4463796daf2773743fcead#rd',
    );
    $news[] = $img;
    $weObj->news($news)->reply();
	}else{
		$weObj->text(lywx_menu())->reply();
		gapushagent('event',array(
	   'category'        => 'lywxother',
	   'action'          => $keyword,
	   'label'           => 'menu get',
	  ));
	}

 //  $wxresources = array();  //TODO： get all (enabled)resources/node of account.
 //  $wxresources = module_invoke_all('wxresources', $wxresources, $account, $keyword,$weObj);
	// $ori_keyword = $keyword;

	// $keyword = 'key_'.$keyword;//1001 => 0 selution.
 //  // watchdog('keyword', $keyword, array(), WATCHDOG_NOTICE, 'link');
 //  // watchdog('ori_keyword', $ori_keyword, array(), WATCHDOG_NOTICE, 'link');
 //  // watchdog('mp_service', '<pre>'.print_r($wxresources,TRUE), array(), WATCHDOG_NOTICE, 'link');
 //  if(isset($wxresources[$keyword])){
 //    switch ($wxresources[$keyword]['type']) {
 //      case 'music':
 //        if(!isset($wxresources[$keyword]['obj']['hgmusicurl']))
 //          $wxresources[$keyword]['obj']['hgmusicurl'] = $wxresources[$keyword]['obj']['musicurl'];
 //        module_load_include('php', 'mp_liangyou', 'liangyou_audio_list');
 //        $radios_list = liangyou_audio_list2();
 //        $radios_keys = array_keys($radios_list);
 //        if(in_array($ori_keyword, $radios_keys)){
 //          $ori_keyword = $radios_list[$ori_keyword]['index'];
 //        }
 //        $weObj->music('【'.$ori_keyword.'】'.$wxresources[$keyword]['obj']['title'], $wxresources[$keyword]['obj']['desc'], $wxresources[$keyword]['obj']['musicurl'], $wxresources[$keyword]['obj']['hgmusicurl']);
 //        break;
 //      case 'text':
 //        $weObj->text($wxresources[$keyword]['obj']['text']);
 //        break;
 //      case 'news':
 //        $new = $wxresources[$keyword]['obj'];
 //        $weObj->news($new);
 //        break;
 //    }
 //    if($account->uid>1) gapushagent('event',array(
 //       'category'        => $wxresources[$keyword]['type'],
 //       'action'          => $ori_keyword,
 //       'label'           => 'wxservice_'.$account->uid,
 //     ));
 //    return;
 //  }
}


/**
 * Hook_wxservice_event_alter
 */
function mp_lywx_wxservice_event_alter($weObj,$event,$account){
	if($account->uid == 1417 && $event['event']=='subscribe'){
    $weObj->text("亲爱的朋友，你好！感谢你关注良友电台官方订阅号“良友知音”！\n".lywx_menu())->reply();
	}
	if($account->uid == 1417){

    if($event['event']=='VIEW'){
      //MP menu!
    }elseif(isset($event['key'])){
    	mp_lywx_keyword_response($weObj,$event['key'],$account);
    }elseif($event['event']=='MASSSENDJOBFINISH'){
      gapushagent('event',array(
       'category'        => '图文发布',
       'action'          => '图文发送成功',
       'label'           => $account->uid,
      ));
    }
    return;
  }
}
