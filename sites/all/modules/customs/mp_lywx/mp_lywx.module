<?php
function lywx_menu(){
return
'输入以下数字代号，可以收听良友电台相关的节目：

生活智慧
101：微播出炉
102：书香园地
103：今夜心未眠
104：绝妙当家
105：生活无国界
106：零点零距离
107：iradio爱广播

关怀辅导
201：空中辅导
202：无限飞行号
203：i关怀心磁场

婚恋家庭
301：恋爱季节
302：幸福满家园
303：亲情不断电
304：欢乐卡恰碰

诗歌音乐
401：齐来颂扬
402：彩虹桥
403：长夜的牵引

慕道探索
501：生命的福音
502：现代人的希望
503：津津乐道

生命成长
601：旷野吗哪
602：生命的四季
603：拥抱每一天
604：施恩座前
605：这一刻清心
606：空中崇拜
607：燃亮的一生
608：佳美脚踪
609：真理之光
610：生根建造
611：给力人生
612：信仰百宝箱
613：空中门训

学习真道
701：真道分解
702：圣言盛宴
703：聆听主道
704：经动人心
705：好牧人
706：善牧良言
707：真理与柱石
708：生活之光

中英双语
801：蓝天绿洲
802：天路导向
803：天路导向粤

少数民族
901：恩典与真理
902：爱在人间

栽培训练
1001：接棒人
1002：晨曦讲座
1003：良院精选';
}
/**
 * hook_rescources_info
 */
function mp_lywx_rescources_info(){
  $rescources[] = array(
    'name' => 'ly',
    'desc' => '良友【100】',
  );
  return $rescources;
}
/**
 * HOOK_wxresources
 * @param  [type] $resources [description]
 * @param  [type] $account   [description]
 * @param  [type] $keyword   [description]
 * @return [type]            [description]
 */
function  mp_lywx_wxresources($resources, $account, $keyword, $weObj){
  if(!is_string($keyword)) return;//!$keyword||
  $enabled_resources = variable_get('wechat_resources_'.$account->uid, array());
  if(!(isset($enabled_resources['ly']) && $enabled_resources['ly'])){
    return;
  }
  //tq begin
  if($keyword=='tq') {
    $img = array(
      'Title'=>"良友67周年台庆微信留言板，点击查看更多～",
      'Description'=>"",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrY4zkXwy5SPZbur1Jd7HMRneGCr0xhsqEJFXyQ0XkTqZmG8xCPIadhCt4GJk0kibtevrUIJ2Wpw7ag/0?wx_fmt=jpeg',
      'Url'=>'http://wx.yongbuzhixi.com/node/2089',
    );
    $news[] = $img;
    $nid = 2089;
    $node = node_load($nid);
    $mode = variable_get('comment_default_mode_' . $node->type, COMMENT_MODE_THREADED);
    $comments_per_page = 10;
    $info = '';
    if ($cids = comment_get_thread($node, $mode, $comments_per_page)) {
      $comments = comment_load_multiple($cids);
      // dpm($comments);
      foreach ($comments as $comment) {
        $registered_name = $comment->registered_name;
        $str = explode('_',$comment->registered_name);
        if(isset($str[1]))
          $registered_name = $str[0];
        $info .= '●'.$registered_name.':'.$comment->comment_body['und'][0]['safe_value']."\n";
      }
    }
    if(empty($info)){
      $info = '恭喜，快来抢沙发吧！发送任意祝福内容+729即可发布哦！';
    }
    $img = array(
      'Title'=>$info,
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'',
      'Url'=>'http://wx.yongbuzhixi.com/node/2089',
    );
    $news[] = $img;
    $resources['key_'.$keyword]= array(
      'type'  =>  'news',
      'gadata' => array(
       'category'        => '图文',
       'action'          => '良友67周年台',
       'label'           => 'wxservice_'.$account->uid,
       ),
      'cache' =>  0,
      'obj'   =>  $news,
    );
    return $resources;
  }//留言板图文end
  if(strpos($keyword,'729')!==false) {
    // $keyword ='一+729';
    // $new_keyword = trim(str_replace('729','',$keyword));
    // $new_keyword = str_replace('+','',$new_keyword);
    // $new_keyword = str_replace('加','',$new_keyword);
    $new_keyword = trim($keyword);
    $new_keyword = zh2cn($new_keyword);
    $questions = array(
      array('question'=>"1.良友电台于哪一年、哪一天启播？",
        'answer'=>array('49','7','29'),//19490729//1949 7 29
        'answerrule'=>'&&',
      ),
      array('question'=>"2.良友电台i-radio爱广播频道（短波）的广播频率是什么？",
        'answer'=>array('9430'),//31公尺9430千赫//31 9430
        'answerrule'=>'&&',
      ),
      array('question'=>"3.良友电台的台长和副台长是谁？",
        'answer'=>array('赵群','唐华'),//赵群唐华//赵群和唐华
        'answerrule'=>'&&',
      ),
      array('question'=>"4.良友电台网上串流排程广播频道的名字是什么？",
        'answer'=>array('同行频道'),//良友电台同行频道
        'answerrule'=>'&&',
      ),
      array('question'=>"5.良友电台微信订阅号的名字是什么？",
        'answer'=>array('良友知音','liangyouzhiyin'),
        'answerrule'=>'||',
      ),
      array('question'=>"6.良友电台官方网站网址是什么？",
        'answer'=>array('729ly.net'),//729ly.net
        'answerrule'=>'&&',
      ),
      array('question'=>"7.良友电台儿童节目的名字是什么？",
        'answer'=>array('欢乐卡恰碰'),
        'answerrule'=>'&&',
      ),
      array('question'=>"8.良友电台的官方短信号码是什么？",
        'answer'=>array('1322', '9966', '122'),
        'answer1'=>array('1322', '9966', '022'),
        'answerrule'=>'&&',
      ),
      array('question'=>"9.良友电台教唱诗歌节目的名称是什么？",
        'answer'=>array('彩虹桥'),
        'answerrule'=>'&&',
      ),
      array('question'=>"10.良友电台现时有哪些中英双语节目？请任举其一。",
        'answer'=>array('天路导向','蓝天绿洲'),
        'answerrule'=>'||',
      ),
      array('question'=>"11.任举一个良友电台手机应用程序的名称。",
        'answer'=>array('聆听同行','聆听关怀','聆听成长'),
        'answerrule'=>'||',
      ),
      array('question'=>"12. 任举三个良友电台少数民族语言节目的名称。",//恩典与真理（回族）
        'answer'=>array('爱在人间','阳光下的喜鹊','祝福康巴','维吾尔佳音','好消息','壮族','傈僳','恩典与真理'),
        'answerrule'=>'||',
        'count'  => 3//满足条件的个数为3个！！！
      ),
      array('question'=>"13.良友电台现时三个直播节目的名称是什么？",
        'answer'=>array('生命的四季','空中辅导','无限飞行号'),
        'answerrule'=>'&&',
      ),
      array('question'=>"14.良友电台i-radio爱广播频道（短波）的发射功率是多少？\n1).10万瓦特\n2).25万瓦特\n3).30万瓦特",
        'answer'=>1,//10万瓦特//十万
        'answerrule'=>'options',
      ),
      array('question'=>"15.良友电台成立以前，曾经在上海哪个地方录音制作节目？\n1)沐恩堂\n2)怀恩堂\n3)国际礼拜堂",
        'answer'=>2,
        'answerrule'=>'options',
      ),
      array('question'=>"16.良友电台2016年节目表背后的福音单张，主题是什么？\n1)破镜重圆\n2)归主怀抱\n3)将心归我",
        'answer'=>1,
        'answerrule'=>'options',
      ),
      array('question'=>"17.良友电台目前共有多少个节目？ \n1)48\n2)54\n3)59",
        'answer'=>3,
        'answerrule'=>'options',
      ),
      array('question'=>"18.下列哪位曾任电台驻台宣教士？ \n1)卢文\n2)江重生\n3)徐婷",
        'answer'=>3,
        'answerrule'=>'options',
      ),
      array('question'=>"19.短波广播的英文代号是什么？ \n1)AM\n2)FM\n3)SW",
        'answer'=>3,
        'answerrule'=>'options',
      ),
      array('question'=>"20.凡向台长报告节目收听讯号，均可获得一张特别的报告卡。此卡的名字是什么？ \n1)QSL卡\n2)收听卡\n3)SW卡",
        'answer'=>1,
        'answerrule'=>'options',
      ),
      array('question'=>"21.良友电台的邮寄地址是什么？",
        'answer'=>array('香港九龙大有街1号10楼','香港九龙大有街一号十楼','香港9龙大有街1号10楼','香港9龙大有街一号十楼'),
        'answerrule'=>'||',
      ),
      array('question'=>"22.良友电台《空中崇拜》节目播放的是哪一家教会的崇拜？ \n1)香港圣经教会\n2)台北信友堂\n3)台北怀恩堂",
        'answer'=>2,
        'answerrule'=>'options',
      ),
      array('question'=>"23.良友电台现时有哪两个祈祷节目？",
        'answer'=>array('这一刻','清心','施恩座前'),
        'answerrule'=>'&&',
      ),
      array('question'=>"24.良友圣经学院本科课程需要通过多少门科目才毕业？ \n1)24  \n2)36  \n3)48",
        'answer'=>2,
        'answerrule'=>'options',
      ),
      array('question'=>"25.良友电台的口号是甚么？",
        'answer'=>array('知音','牵手','同行'),//知音牵手同行
        'answerrule'=>'&&',
      ),
      array('question'=>"26.良友电台专为残疾人而设的节目叫甚么？",
        'answer'=>array('无限飞行号'),
        'answerrule'=>'&&',
      ),
      array('question'=>"27.良友圣经学院的院长是谁？",
        'answer'=>array('周广亮','周广亮牧师'),
        'answerrule'=>'||',
      ),
      array('question'=>"28.良友电台圣经广播剧节目的名称是什么？",
        'answer'=>array('经动人心'),
        'answerrule'=>'&&',
      ),
      array('question'=>"29.哪一个节目是为少数民族而设，却用普通话广播？",
        'answer'=>array('恩典与真理'),
        'answerrule'=>'&&',
      ),
      array('question'=>"30.良友、益友电台的发射站分别在哪个国家？",
        'answer'=>array('韩国','菲律宾'),
        'answerrule'=>'&&',
      ),
    );
    $index  = (date('z')+1)%30;//0-29
    // $index = 18;
    // $keyword = '729@1';
    $qindex = explode('@', $new_keyword);//todo delete!!!
    if(isset($qindex[1])) $index = $qindex[1];//todo delete!!!
    $aindex = explode('+', $new_keyword);//todo delete!!!
    if(isset($aindex[1])) $index = $aindex[1];//todo delete!!!

    $question = $questions[$index-1];
    // dpm($question);
    $text = '今天是'.date('Y-m-d').'距良友电台729台庆还有'.((int)((strtotime('2016-07-29 23:59:59')-time())/86400))."天。\n";

    if(((strlen($keyword)==5||strlen($keyword)==6) && isset($qindex[1]))||$keyword=='729'){//todo delete!!!
      $text .= "热题30今日题目是：\n".$question['question'];
      $weObj->text($text)->reply();
      return;
    }
    switch ($question['answerrule']) {
      case '&&':
        $return = TRUE;
        foreach ($question['answer'] as $value) {
          if(strpos($new_keyword,$value)===FALSE){
            $return = FALSE; break;
          }
        }
        break;
      case '||':
        $return = FALSE;
        if(isset($question['count'])) {
          $max = $question['count'];
          $count = 0;
        }
        foreach ($question['answer'] as $value) {
          if(strpos($new_keyword,$value)!==FALSE){
            if(isset($count)) {
              $count++;
              if($count == $max){
                $return = TRUE;
                break;
              }
            }else{
            $return = TRUE; break;
            }
          }
        }
        break;
      case 'options':
        $aindex = explode('+', $keyword);//todo delete!!!
        if(isset($aindex[2])) $keyword = $aindex[2];//todo delete!!!
        $new_keyword = str_replace('729','',$keyword);
        $return = FALSE;
        switch ($new_keyword) {
          case '一':
            $new_keyword=1;
            break;
          case '二':
            $new_keyword=2;
            break;
          case '三':
            $new_keyword=3;
            break;
          default:
            break;
        }
        if((int)$new_keyword==$question['answer']){
          $return = TRUE;
        }
        break;
      default:
        # code...
        break;
    }
    if($return){
      $text .= $question['question']."\n您的答案是：".$keyword."\n恭喜您答对了！";
    }else{
      $text .= $question['question']."\n您的答案是：".$keyword."\n很遗憾，答错了！再试一下吧！";
    }
    $weObj->text($text)->reply();
    // dpm($text);
    //TODO only answer one time!!! comments!!
    //@see function mp_service_comments()
      // $node_type = 'ly729qa';
      $nid = 2110;
      $id = $weObj->getRevID();
      $pid = 0;
      $openid = $weObj->getRev()->getRevFrom();
      $user_info = $weObj->getUserInfo($openid);
      $user_info = (array)$user_info;
      $comment_body = $keyword;

      $mail = $user_info['openid'].'@wechat.bind';
      $account = user_load_by_mail($mail);
      if(!$account){
        // watchdog('create user '.$mail, 'message', array(), WATCHDOG_NOTICE, 'link');
        // create $user;
        // $response = drupal_http_request($user_info['headimgurl']);
        // if ($response->code == 200){
        //   $file = file_save_data($response->data, 'public://users/'. $user_info['openid'].'.jpg');
        // }
        $ori_user_name = mp_strip_utf8mb4_for_text_fields($user_info['nickname'],'?');
        $user_name = $ori_user_name;
        $user_info['nickname'] = $ori_user_name;
        $count = 0;
        while(user_load_by_name($user_name)){
          // $user_name = $user_name.rand(0, 100);
          $user_name = $ori_user_name.'_'.$count;
          $count ++;
        }
        $pass = date('Ymd');
        $new_user = array(
          'name' => $user_name,
          'pass' => $pass,//user_password()
          'mail' => $mail,
          'init' => $mail,
          // 'picture'=> $file->fid,
          'status' => 1,
          'data'  => $user_info,
          'roles' => array(
            DRUPAL_AUTHENTICATED_RID => 'authenticated user',
          ),
          // 'field_sex' => 1,2男 ＝》 0 男 1 女
          'field_user_sex' => array(LANGUAGE_NONE => array(array('value' => ($user_info['sex'])%2))),
        );
        $account = user_save(null, $new_user);
        if(!$account){
          // drupal_set_message('账户创建失败！', 'error', FALSE);
          watchdog('mp_lywx', '账户创建失败！', array(), WATCHDOG_NOTICE, 'error');
        }
        // drupal_set_message('恭喜您成功注册！', 'status', FALSE);
      }
      // check comment ID
      {
        // dpm($nid,'nid');
        // dpm($pid,'pid');
        // dpm($comment_body,'comment_body');
        $comment = new stdClass();
        $comment->nid = $nid; // nid of a node you want to attach a comment to
        $comment->cid = 0; // leave it as is
        $comment->pid = $pid; // parent comment id, 0 if none
        $comment->uid = $account->uid; // user's id, who left the comment

        $comment->mail = $mail;//
        // $comment->thread = '01/'; // OPTIONAL. If you need comments to be threaded you can fill this value. Otherwise omit it.
        $comment->name = $account->name;//; // If user is authenticated you can omit this field, it will be auto-populated, if the user is anonymous and you want to name him somehow, input his name here
        // $comment->thread = '01/'; // OPTIONAL. If you need comments to be threaded you can fill this value. Otherwise omit it.
        $comment->hostname = $_SERVER['REMOTE_ADDR'] ;// OPTIONAL. You can log poster's ip here
        $comment->created = time(); // OPTIONAL. You can set any time you want here. Useful for backdated comments creation.
        $comment->is_anonymous = 0; // leave it as is
        $comment->homepage = ''; // you can add homepage URL here

        // $status = COMMENT_PUBLISHED;
        // if($pid != 0) $status = COMMENT_PUBLISHED;
        $comment->status = COMMENT_PUBLISHED; // We auto-publish this comment
        $comment->language = LANGUAGE_NONE; // The same as for a node
        // $keyword = substr($keyword, 2);
        $subject = truncate_utf8($comment_body, 15, $wordsafe = FALSE, $add_ellipsis = FALSE, $min_wordsafe_length = 1);
        $comment->subject = $subject;

        // $comment->signature = '';//$wechat_user_info['contact_info']['signature'] ;

        // $comment->signature_format = 'filtered_html';
        $comment->comment_body[$comment->language][0]['value'] = $comment_body; // Everything here is pretty much like with a node
        $comment->comment_body[$comment->language][0]['format'] = 'filtered_html';
        // $comment->field_custom_field_name[LANGUAGE_NONE][0]['value'] = 'Some value'; // OPTIONAL. If your comment has a custom field attached it can added as simple as this // preparing a comment for a save
         // saving a comment
        $comment->field_wxuid[$comment->language][0]['value'] = $openid;
        $comment->field_questionid[$comment->language][0]['value'] = $index;
        $comment->field_rightwrong[$comment->language][0]['value'] = $return?1:0;
        ///////////end
        if($comment = comment_submit($comment)) { // Prepare node for saving
          comment_save($comment);
          return;
            // return $comment;
        }
      }
    //end function mp_service_comments()
  }
  //tq end!

  $my_data = _mp_lywx_wxresources($resources, $account, $keyword,$weObj);
  // return $my_data;
  $my_data = &drupal_static(__FUNCTION__);
  if (!isset($my_data)) {
    if ($cache = cache_get('mp_lywx_wxresources_'.$account->uid.$keyword)) {
      $my_data = $cache->data;
      //DEBUG TO DELETE!
      if($keyword=='202'||$keyword=='603'){
        $str = date('ymd');
        $pos = strpos($my_data['key_'.$keyword]['obj']['musicurl'], $str);
        if($pos === false){
          watchdog('mp_lywx', $keyword.'-'.$str.'-'.$my_data['key_'.$keyword]['obj']['musicurl'], array(), WATCHDOG_NOTICE, 'error');
        }
      }
      //DEBUG TO DELETE later!
    }else {
      $my_data = _mp_lywx_wxresources($resources, $account, $keyword,$weObj);
      //cache = 0;永久缓存 cache = 43200;缓存一天／2
      if(isset($my_data['key_'.$keyword]['cache'])){
        if($my_data['key_'.$keyword]['cache']==0){
          cache_set('mp_lywx_wxresources_'.$account->uid.$keyword, $my_data, 'cache');
        }else{
          cache_set('mp_lywx_wxresources_'.$account->uid.$keyword, $my_data, 'cache', time() + $my_data['key_'.$keyword]['cache']);
        }
      }
    }
  }
  return $my_data;
}

function _mp_lywx_wxresources($resources, $account, $keyword, $weObj){

  $allowkeywords = array('0');
  //1. 如輸入”0”時，會自動發送圖文“收听节目代号”。
  if(in_array($keyword, $allowkeywords)){
    $img = array(
      'Title'=>"收听节目代号",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrY4zkXwy5SPZbur1Jd7HMRneGCr0xhsqEJFXyQ0XkTqZmG8xCPIadhCt4GJk0kibtevrUIJ2Wpw7ag/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401924143&idx=1&sn=9e7a4f6f8390b6a807060b99e9975c4a#rd',
    );
    $news[] = $img;
    $resources['key_'.$keyword]= array(
      'type'  =>  'news',
      'gadata' => array(
       'category'        => '图文',
       'action'          => '收听节目代号',
       'label'           => 'wxservice_'.$account->uid,
       ),
      'cache' =>  0,
      'obj'   =>  $news,
      );
    return $resources;
  }

  $ori_keyword = $keyword;
  module_load_include('php', 'mp_liangyou', 'liangyou_audio_list');
  $liangyou_audio_list = liangyou_audio_list_bylywxindex();
  // 101-901
	if(in_array($keyword, array_keys($liangyou_audio_list))){
    $lywx = (int)$keyword;
		$liangyou_audio_list_info = $liangyou_audio_list[(int)$keyword];
		$ori_title = $liangyou_audio_list_info['title'];
		$code = $liangyou_audio_list_info['code'];
		$lywx = $liangyou_audio_list_info['lywx'];
		// http://lywxaudio.b0.upaiyun.com/2016/zz/zz160205.mp3
		// $dir_stru = 'liangyou/nissigz/'.$title.'/'.date('Ym');

		$upyun_bucket_name = 'lywxaudio';
		$cdnlink = $upyun_bucket_name.'.yongbuzhixi.com';

		$offset=0;
		while ($offset <= 7) {
			$date = date('ymd',time()-$offset*86400);
			$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
			$musicurl = 'http://'.$cdnlink.$path;
      $upyunurl = $musicurl.upyun_get_token($path);
			$temp = @get_headers($upyunurl);
			if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
				$title = '【'.$lywx.'】'.$ori_title;
				$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' '.$date;
		    // $weObj->music($title , $desc, $musicurl, $musicurl)->reply();
        $resources['key_'.$ori_keyword]= array(
          'type'  =>  'music',
          'gadata'   =>  array(
             'category'        => 'lywxaudio',
             'action'          => $ori_title,
             'label'           => 'wxservice_'.$account->uid,
          ),
          'path'  => $path,
          'cache' => 43201,
          'obj'   => array(
            'title' => $title,
            'desc'  => $desc,
            'musicurl'  =>  $musicurl,
            'hgmusicurl'  =>  $musicurl,
          ),
        );
        return $resources;
			}
			$offset++;
		}
	}
  //get audio by title
	$liangyou_audio_list = liangyou_audio_list_bytitle();
	if(in_array($keyword, array_keys($liangyou_audio_list))){
		$liangyou_audio_list_info = $liangyou_audio_list[$keyword];
		$ori_title = $keyword;//$liangyou_audio_list_info['title'];
		$code = $liangyou_audio_list_info['code'];
		$lywx = $liangyou_audio_list_info['lywx'];
		// http://lywxaudio.b0.upaiyun.com/2016/zz/zz160205.mp3
		// $dir_stru = 'liangyou/nissigz/'.$title.'/'.date('Ym');

		$upyun_bucket_name = 'lywxaudio';
		$cdnlink = $upyun_bucket_name.'.yongbuzhixi.com';
		$offset=0;
		while ($offset <= 7) {
			$date = date('ymd',time()-$offset*86400);
			$path = '/'.date('Y').'/'.$code.'/'.$code.$date.'.mp3';
			$musicurl = 'http://'.$cdnlink.$path;
      $upyunurl = $musicurl.upyun_get_token($path);
      $temp = @get_headers($upyunurl);
			if($temp[0] == 'HTTP/1.1 200 OK'){//远程有!!!
				$title = '【'.$lywx.'】'.$ori_title;
				$desc = "点击►收听 公众号:".variable_get('mp_config_appname_'.$account->uid, "永不止息").' '.$date;
		    // $weObj->music($title , $desc, $musicurl, $musicurl)->reply();
        $resources['key_'.$ori_keyword]= array(
          'type'  =>  'music',
          // 'gakey'   =>  $ori_title,
          'gadata'   =>  array(
             'category'        => 'lywxaudio',
             'action'          => $ori_title,
             'label'           => 'wxservice_'.$account->uid,
          ),
          'path'  => $path,
          'cache' => 43201,
          'obj'   => array(
            'title' =>  $title,
            'desc'  => $desc,
            'musicurl'  =>  $musicurl,
            'hgmusicurl'  =>  $musicurl,
          ),
        );
        return $resources;
			}
			$offset++;
		}
	}

  $len = strlen($ori_keyword);
  if($len > 30) {
    $nid = 113;
    $node_type = 'wxcomments';
    //POST($user_info,$ori_keyword);
    $id = $weObj->getRevID();
    // watchdog('id?', $id, array(), WATCHDOG_NOTICE, 'link');
    // if(variable_get('mp_config_wxcomments_before', '0') == $id) {
    //   watchdog('prevent twice post by wechat servuce!', 'message', array(), WATCHDOG_NOTICE, 'link');
    //   return;
    // }
    $openid = $weObj->getRev()->getRevFrom();
    $user_info = $weObj->getUserInfo($openid);

    $comment_body = $ori_keyword;

    preg_match('/@\d{4}/', $ori_keyword,$m);//$m[0]=@2089
    if(isset($m[0])){
      $nid = str_replace('@', '', $m[0]);
      $comment_body =  str_replace($m[0], '', $comment_body);
    }

    if (strpos($ori_keyword,'729') !== false || strpos($ori_keyword,'台庆') !== false || strpos($ori_keyword,'生日') !== false) {
      $nid = 2089;
      $comment_body = $ori_keyword;
    }
    $pid = 0;
    $str = explode('?',$comment_body);
    if(isset($str[1])){
      $str2 = explode('#',$str[1]);
      if(isset($str2[0])){
        if(node_load($str2[0]))
          $nid = $str2[0];
      }
      if(isset($str2[1]))
        $pid = $str2[1];
    }
    $url = url(NULL, array('absolute' => TRUE)) . (variable_get('clean_url', 0) ? '' : '?q=').'node/'.$nid;
    // $resources = mp_lywx_wxresources($resources, $account, 'tq', $weObj);
    $weObj->text("评论留言成功！\n审核后会<a href='".$url."'>出现在这里哦</a>！")->reply();
    //...TODO sen news!
    $before = variable_get('mp_config_wxcomments_wxid', '0');
    // dpm($before);
    // watchdog('before', $before, array(), WATCHDOG_NOTICE, 'link');
    // watchdog('id', $id, array(), WATCHDOG_NOTICE, 'link');
    if($before!=$id){
      variable_set('mp_config_wxcomments_wxid', $id);
      _post_wxcomments($user_info,$comment_body,$nid,$id,$pid);
      if($account->uid>1) gapushagent('event',array(
       'category'        => 'comments',
       'action'          => $ori_keyword,
       'label'           => 'wxservice_'.$account->uid,
      ));
    }
    return $resources;
  }


  if(date('md')!='0729')//台庆当天不使用微信客服功能
  if (strpos($ori_keyword,'您好') !== false||
      strpos($ori_keyword,'你好') !== false||
      strpos($ori_keyword,'请') !== false||
      strpos($ori_keyword,'播') !== false||
      strpos($ori_keyword,'哪') !== false||
      strpos($ori_keyword,'我') !== false||
      strpos($ori_keyword,'想') !== false||
      strpos($ori_keyword,'么') !== false||
      strpos($ori_keyword,'吗') !== false||
      strpos($ori_keyword,'几') !== false
    ){
    $weObj->transfer_customer_service()->reply();
    gapushagent('event',array(
     'category'        => 'getservice',
     'action'          => $ori_keyword,
     'label'           => 'wxservice_'.$account->uid,
    ));
    return ;
  }
  //2. 如輸入”0”或節目代號以外的任何數字、英文、符號等，會自動發送圖文“良友知音使用说明”。
  $img = array(
    'Title'=>"良友知音使用说明",
    'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
    'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrY4zkXwy5SPZbur1Jd7HMRneGCr0xhsqEJFXyQ0XkTqZmG8xCPIadhCt4GJk0kibtevrUIJ2Wpw7ag/0?wx_fmt=jpeg',
    'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=403749894&idx=1&sn=0158a36a4c6d87aed8c7bad66a738791#rd',
  );
  $news[] = $img;
  $resources['key_'.$keyword]= array(
    'type'  =>  'news',
    'gadata' => array(
     'category'        => '图文',
     'action'          => '良友知音使用说明',
     'label'           => 'wxservice_'.$account->uid,
     ),
    'cache' =>  0,
    'obj'   =>  $news,
    );
  return $resources;
}


/**
 * Hook_wxservice_event_alter
 */
function mp_lywx_wxservice_event_alter($weObj,$event,$account){
  $enabled_resources = variable_get('wechat_resources_'.$account->uid, array());
  if(!(isset($enabled_resources['ly']) && $enabled_resources['ly'])){
    return;
  }
  // watchdog('mp_lywx', '<pre>'.print_r($event, 1), array(), WATCHDOG_NOTICE, 'link');
  if($event['event']=='subscribe'){
    $img = array(
      'Title'=>"良友知音使用说明",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrY4zkXwy5SPZbur1Jd7HMRneGCr0xhsqEJFXyQ0XkTqZmG8xCPIadhCt4GJk0kibtevrUIJ2Wpw7ag/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=403749894&idx=1&sn=0158a36a4c6d87aed8c7bad66a738791#rd',
    );
    $news[] = $img;
    $img = array(
      'Title'=>"收听节目代号",
      'Description'=>"欢迎收听我们的节目！知音‧牵手‧同行 ※ 为你送上精彩节目和活动！",
      'PicUrl'=>'https://mmbiz.qlogo.cn/mmbiz/JkVibryc6qrY4zkXwy5SPZbur1Jd7HMRneGCr0xhsqEJFXyQ0XkTqZmG8xCPIadhCt4GJk0kibtevrUIJ2Wpw7ag/0?wx_fmt=jpeg',
      'Url'=>'http://mp.weixin.qq.com/s?__biz=MzI1MDE0NzM5Ng==&mid=401924143&idx=1&sn=9e7a4f6f8390b6a807060b99e9975c4a#rd',
    );
    $news[] = $img;
    // $weObj->text("亲爱的朋友，你好！感谢你关注良友电台官方订阅号“良友知音”！\n".lywx_menu());
    $weObj->news($news);
  }
}

/**
 * Implements hook_node_view().
 */
function mp_lywx_node_view($node, $view_mode, $langcode) {
  $nid = 2089;
  if($node->nid == $nid && $view_mode=='full'){
    global $user;
    if(isset($_GET['award'])&& $user->uid == $node->uid){
      $query = db_select('comment', 'c');
      $query->join('users', 'u', 'c.uid = u.uid'); //JOIN node with users
      $query->condition('c.nid', $nid);
      $query->groupBy('c.uid');//GROUP BY user ID
      $query->fields('u', array('name'));
      $query->fields('u', array('uid'));
      $result = $query->execute()->fetchAll();

      $count = db_query('SELECT c.cid FROM {comment} c WHERE c.nid = :nid', array(':nid' => $nid));
      $count->fetchCol();
      $count = $count->rowCount();

      $min=0; $max=count($result)-1; $quantity=3;
      $awards = '截至'.date('Y.m.d H:i').',微信参与人数：'.$max.'; 总共接受到用户发送微信互动消息'.$count."条; 本次随机抽取的".$quantity."位听众如下：<br/><ol id='729award'>";
      $numbers = range($min,$max);
      shuffle($numbers);
      $indexs = array_slice($numbers, 0, $quantity);
      foreach ($indexs as $index) {
        $registered_name = $result[$index]->name;
        $str = explode('_',$result[$index]->name);
        if(isset($str[1]))
          $registered_name = $str[0];
        $account = user_load($result[$index]->uid);
        $province = isset($account->data['province'])?$account->data['province']:'';
        $city = isset($account->data['city'])?$account->data['city']:'';
        $sex = '未知';
        if(isset($account->field_user_sex['und'][0]['value'])){
          $sex=$account->field_user_sex['und'][0]['value']?'弟兄':'姊妹';
        }
        $awards .= '<li>'.$result[$index]->uid .'：'. $registered_name .$sex.' '.$province.$city. "</li>";
      }
      $awards .= '</ol>';
      $node->content['my_additional_field'] = array(
        '#markup' => $awards,
        '#weight' => 10,
      );return $node;
    }
  }

  $nid = 2110;
  if($node->nid == $nid && $view_mode=='full'){
    global $user;
    if(in_array('义工编辑',$user->roles)){
      $nid = 2110;
      $result = db_query('SELECT c.uid FROM {comment} c WHERE c.nid = :nid', array(':nid' => $nid));
      $uids = $result->fetchCol();
      $count = $result->rowCount();
      $uids = array_unique($uids);

      $max=count($result)-1;
      $awards = '截至'.date('Y.m.d H:i').',微信参与问答人数：'.count($uids).'; 总共接受到用户发送微信问答消息'.$count."条；听众回答排行榜：<br/><ul id='729award'>";

      if (!function_exists('sortByCount')){
        function sortByCount($a, $b) {
            $a = count($a);
            $b = count($b);

            if($a == $b) {
                return 0;
            }

            return ($a > $b) ? -1 : 1;
        }
      }
      //get all right answers cid&qid
      $query = db_select('field_data_field_questionid', 'q');
      $query->join('field_data_field_rightwrong', 'r', 'r.entity_id = q.entity_id');
      $query->fields('q', array('entity_id','field_questionid_value'));
      // $query->fields('r', array('field_rightwrong_value'));
      $query->condition('r.field_rightwrong_value', 1);
      $results = $query->execute()->fetchAll();
      // dpm($results);
      foreach ($results as $result) {
        $query = db_select('comment', 'c');
        $query->fields('c', array('name','uid'));
        $query->condition('c.cid', $result->entity_id);//
        $ccuser = $query->execute()->fetchAll();
        $top[$ccuser[0]->uid][$result->field_questionid_value] = $ccuser[0]->name;
      }
      uasort($top, 'sortByCount');
      // dpm($top);
      foreach ($top as $uid => $value) {
        $account = user_load($uid);
        $registered_name = $account->name;
        $str = explode('_',$account->name);
        if(isset($str[1]))
          $registered_name = $str[0];
        $province = isset($account->data['province'])?$account->data['province']:'';
        $city = isset($account->data['city'])?$account->data['city']:'';
        $sex = '未知';
        if(isset($account->field_user_sex['und'][0]['value'])){
          $sex=$account->field_user_sex['und'][0]['value']?'弟兄':'姊妹';
        }
        $awards .= '<li>'.count($value).'：'. $registered_name .$sex.' '.$province.$city. "</li>";
      }
      $awards .= '</ol>';

      $node->content['my_additional_field'] = array(
        '#markup' => $awards,
        '#weight' => 10,
      );return $node;
    }
  }
}


